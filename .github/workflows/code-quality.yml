name: ğŸ“ Code Quality & Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ğŸ” Code Formatting
  formatting:
    name: ğŸ¨ Code Formatting Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ¨ Check Prettier Formatting
        run: npm run format:check
        
      - name: ğŸ“Š Format Check Report
        if: failure()
        run: |
          echo "âŒ Code formatting issues found!"
          echo "Run 'npm run format' to fix formatting issues"
          npm run format:check || true

  # ğŸ”’ Security Scanning
  security:
    name: ğŸ”’ Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
          cache: 'npm'
          
      - name: ğŸ”’ NPM Audit
        run: |
          echo "ğŸ” Running npm audit..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found"
          
      - name: ğŸ”’ Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'ARIA'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --suppression dependency-check-suppressions.xml
        continue-on-error: true
        
      - name: ğŸ“‹ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: reports/
        if: always()

  # ğŸ“Š Code Analysis
  code-analysis:
    name: ğŸ“Š Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ” ESLint Analysis
        run: |
          echo "ğŸ” Running ESLint analysis..."
          npm run lint:check || echo "âš ï¸ Linting issues found"
          
      - name: ğŸ” TypeScript Analysis
        run: |
          echo "ğŸ” Running TypeScript analysis..."
          npm run typecheck
          
      - name: ğŸ“Š Complexity Analysis
        run: |
          echo "ğŸ“Š Code complexity analysis:"
          find src -name "*.ts" -o -name "*.tsx" | xargs wc -l | sort -n
          echo "ğŸ“ˆ File count by type:"
          find src -name "*.ts" | wc -l | xargs echo "TypeScript files:"
          find src -name "*.tsx" | wc -l | xargs echo "React components:"

  # ğŸ—ï¸ Architecture Validation
  architecture:
    name: ğŸ—ï¸ Architecture Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Validate Project Structure
        run: |
          echo "ğŸ—ï¸ Validating ARIA architecture..."
          
          # Check core directories exist
          dirs=("src/api" "src/components" "src/screens" "src/state" "src/types" "src/utils" "src/navigation")
          for dir in "${dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir exists"
            else
              echo "âŒ $dir missing"
              exit 1
            fi
          done
          
          # Check core API files
          api_files=(
            "src/api/advanced-reasoning.ts"
            "src/api/vision-system.ts"
            "src/api/audio-system.ts"
            "src/api/sensor-manager.ts"
            "src/api/context-engine.ts"
            "src/api/autonomous-system.ts"
          )
          
          for file in "${api_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # Check screen files
          screen_files=(
            "src/screens/HomeScreen.tsx"
            "src/screens/ChatScreen.tsx"
            "src/screens/VisionScreen.tsx"
            "src/screens/AudioScreen.tsx"
            "src/screens/SensorsScreen.tsx"
            "src/screens/AnalysisScreen.tsx"
            "src/screens/AutonomousScreen.tsx"
          )
          
          for file in "${screen_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          echo "ğŸ‰ Architecture validation passed!"

  # ğŸ“± React Native Validation
  react-native-validation:
    name: ğŸ“± React Native Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ“± React Native Best Practices Check
        run: |
          echo "ğŸ“± Checking React Native best practices..."
          
          # Check for proper imports
          echo "ğŸ” Checking imports..."
          if grep -r "import.*react-native.*TouchableOpacity" src/; then
            echo "âš ï¸ Found TouchableOpacity usage - prefer Pressable"
          else
            echo "âœ… No TouchableOpacity found - good!"
          fi
          
          # Check for proper navigation usage
          echo "ğŸ” Checking navigation..."
          if grep -r "@react-navigation/native-stack" src/; then
            echo "âœ… Using native stack navigation"
          else
            echo "âš ï¸ Consider using native stack navigation"
          fi
          
          # Check for safe area usage
          echo "ğŸ” Checking safe area usage..."
          if grep -r "react-native-safe-area-context" src/; then
            echo "âœ… Using safe area context"
          else
            echo "âš ï¸ Consider using safe area context"
          fi
          
          # Check for reanimated usage
          echo "ğŸ” Checking animations..."
          if grep -r "react-native-reanimated" src/; then
            echo "âœ… Using react-native-reanimated"
          else
            echo "âš ï¸ Consider using react-native-reanimated for animations"
          fi
          
          echo "ğŸ“± React Native validation completed!"

  # ğŸ¤– AI Integration Validation
  ai-validation:
    name: ğŸ¤– AI Integration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ¤– AI System Validation
        run: |
          echo "ğŸ¤– Validating AI integration..."
          
          # Check for API key handling
          echo "ğŸ” Checking API key security..."
          if grep -r "process\.env\." src/ | grep -v "test" | grep -v "example"; then
            echo "âœ… Found environment variable usage"
          else
            echo "âš ï¸ No environment variables found"
          fi
          
          # Check for hardcoded API keys (security)
          echo "ğŸ”’ Checking for hardcoded secrets..."
          if grep -r "sk-" src/ | grep -v "example" | grep -v "test"; then
            echo "âŒ Potential hardcoded API key found!"
            exit 1
          else
            echo "âœ… No hardcoded API keys found"
          fi
          
          # Check AI model integration
          echo "ğŸ§  Checking AI model integration..."
          models=("openai" "anthropic" "grok")
          for model in "${models[@]}"; do
            if grep -r "$model" src/api/; then
              echo "âœ… $model integration found"
            else
              echo "âš ï¸ $model integration not found"
            fi
          done
          
          echo "ğŸ¤– AI validation completed!"